---
layout: post
title: "不务正业 | 文档生成工具apiDoc"
date: 2016-11-23
description: "发现了个小东西"
tag: coding
---   

本来应该是在研究webrtc的,但是混蛋项目前负责人给我甩了个美国的ftp让我去扒代码,来来来感受一下这个速度
![downloadSnap](http://img.nufe-cst.cn/ab2b1c6c1d51.png)

于是在扒代码的同时,着手开工写手头另一个项目的文档,之前的api都是用md手写的,后来随着项目越发复杂,这个方式不再高效,于是着手调研了一番自动文档生成工具.

进入我视野并且试用过的有2种

* [swagger](http://swagger.io/)
* [apiDoc](http://apidocjs.com)

先说[swagger](http://swagger.io/),它利用java注解来实现文档的自动生成,只要项目部署到服务器上,访问对应url就能直接看到项目文档.我不选择这个工具的原因是:
1. 直接把文档作为代码的一部分放入工程,随着项目日渐庞大势必增加编译时间和编译结果尺寸.
2. 文档内容并不随时跟着接口改变,相当于同时维护两份代码,如何保持一致性是一个难以解决的问题.
3. 嵌入代码相当于在生产环境也要占用一部分资源进行文档的存储渲染,浪费资源.虽然可以通过条件编译解决这个问题,但是我懒:)

再讲[apiDoc](http://apidocjs.com),apiDoc采用注释方式来解决文档生成问题,一个常见的文档是这样的
{% highlight java %}
/**
 *
 * @api {get} /bird/:speciesId birdById
 * @apiName birdById
 * @apiGroup bird
 * @apiVersion 0.1.0
 * @apiDescription 关键词查找 可用拉丁名 英文名 中文名查找鸟种
 * @apiPermission anyone
 * @apiParam :speciesId 鸟种id
 * @apiParamExample {json} Request Example
 *    GET /bird/:speciesId
 *
 * @apiSuccess {String} code 88
 * @apiSuccess {String} message ok
 * @apiSuccess {Object} data ok
 * @apiSuccess {String} data.englishName
 * @apiSuccess {String} data.familia 科
 * @apiSuccess {String} data.genus 属
 * @apiSuccess {int} data.id 鸟种id
 * @apiSuccess {String} data.latinName
 * @apiSuccess {String} data.localName
 * @apiSuccess {String} data.order 目
 * @apiSuccess {String} data.shape 体型大小
 * @apiSuccessExample Success-Response:
 *  HTTP/1.1 200 OK
 *{
 *    "code": 88,
 *    "data": [
 *        {
 *            "englishName": "Snow Partridge",
 *            "familia": "雉科",
 *            "genus": "雪鹑属",
 *            "id": 1,
 *            "latinName": "Lerwa lerwa",
 *            "localName": "雪鹑",
 *            "order": "鸡形目",
 *            "shape": "斑鸠与鸬鹚之间"
 *        }
 *    ],
 *    "message": "ok"
 *}
 */
{% endhighlight %}
apiDoc的优势在于:

1. 作为注释存在于源文件,修改接口的同时直接修改文档,不存在同时操作两份文件的问题.同时,编译时直接忽略注释,对后续的业务流程没有影响.
2. 文档内容并不随时跟着接口改变这个问题虽然还是没有解决,但是相比于其他优势,这个就当妥协了吧.
3. 除了代码本身,不占用任何资源

**Get Started**


apiDoc基于node.js,所以我们需要一个npm,还没有的同学自己百度怎么下载

在shell执行
{% highlight shell %}
npm install apidoc -g
{% endhighlight %}
由于国内网络问题,这个步骤可能需要等待比较长的时间.

在项目根目录创建apidoc.json(如果是node.js项目,可以直接在package.json中加入apiDoc的配置项),常见的配置为
{% highlight json %}
{
  "name": "example",
  "version": "0.1.0",
  "description": "A basic apiDoc example"
}
{% endhighlight %}

在代码中使用注释编写文档(各种语言的注释格式可见[apiDoc](http://apidocjs.com),此处以Java为例),具体语法见[这里](http://apidocjs.com/#params),[中文版](http://blog.csdn.net/soslinken/article/details/50468896)

编写完后,在shell执行
{% highlight shell %}
apidoc -i ./ -o ./doc/
{% endhighlight %}
此处参数意义为:
* -i [inputPath]
* -o [outputPath]
此时就可以在根目录/doc文件夹看到生成的文档了,打开index.html,就能看到所有的api以group-name的方式升序排列.可以编写脚本直接上传到服务端.

附一个文档生成结果:[api.ebirdnote.cn/doc](http://api.ebirdnote.cn/doc),这就是通过默认模板生成的RESTful api document,其实apidoc内置了调试器,但是在post请求中无法使用json作为body编码方式,我暂时也没时间解决这个问题,有解决方案的同学欢迎给我发一个链接到[我的邮箱](mailto:i@edzh.me),感激不尽
